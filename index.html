<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
  <title>YT</title>
  <style>
    /* RESET */
    * { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol" }
    html,body,h1,h2,h3,h4,h5,h6 { margin: 0; padding: 0; }

    /* THEME */
    body {
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
      padding: 20px;
    }
    .hidden {
      display: none;
    }
    .error {
      padding: 20px;
      background: darkred;
      color: white;
      font-weight: bold;
      font-family: monospace;
    }
    .controls {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap-reverse;
      justify-content: center;
      padding-top: 20px;
    }
    .controls article, .player {
      border-radius: 5px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }
    .controls article {
      margin: 1%;
      background: white;
      transform: scale3d(1, 1, 1);
      transition: all 150ms cubic-bezier(0.175, 0.885, 0.32, 1.275);

      /* SQUARE */
      width: 20%;
      height: 0;
      padding-bottom: 20%;

      /* LAYOUT */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
    }
    .controls article::before {
      content: attr(data-note);
      color: grey;
      padding: 25% 0 10%;
      font-weight: bold;
      font-size: 16px;
    }
    .controls input {
      width: 80%;
      text-align: center;
      background: transparent;
      border: none;
      border-bottom: solid 1px grey;
      font-size: 16px;
    }
    .controls article.pressed {
      transform: scale3d(.9, .9, 1);
      box-shadow: none;
    }

    /* SW-NE Gradient using alternating "100" values from https://material.io/design/color */
    .controls article.pressed:nth-child(0)  { background: #FFCDD2 }
    .controls article.pressed:nth-child(1),
    .controls article.pressed:nth-child(4)  { background: #E1BEE7 }
    .controls article.pressed:nth-child(2),
    .controls article.pressed:nth-child(5),
    .controls article.pressed:nth-child(8)  { background: #C5CAE9 }
    .controls article.pressed:nth-child(3),
    .controls article.pressed:nth-child(6),
    .controls article.pressed:nth-child(9)  { background: #B3E5FC }
    .controls article.pressed:nth-child(7),
    .controls article.pressed:nth-child(10) { background: #B2DFDB }
    .controls article.pressed:nth-child(11) { background: #DCEDC8 }

    /* embedresponsively.com */
    .player {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      max-width: 100%;
    }
    .player iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div class="player"><div id="player"></div></div>
  <div class="error hidden"></div>
  <div class="controls hidden">
    <article data-note="C" ><input></article>
    <article data-note="C#"><input></article>
    <article data-note="D" ><input></article>
    <article data-note="D#"><input></article>
    <article data-note="E" ><input></article>
    <article data-note="F" ><input></article>
    <article data-note="F#"><input></article>
    <article data-note="G" ><input></article>
    <article data-note="G#"><input></article>
    <article data-note="A" ><input></article>
    <article data-note="A#"><input></article>
    <article data-note="B" ><input></article>
  </div>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    function onYouTubeIframeAPIReady() {
      new YT.Player("player", {
        events: { onError, onReady },
        videoId: "_AVxxcRRshU", // TODO
        playerVars: { disablekb: 1, modestbranding: 1 },
      });
    }

    function onError(event) {
      const message = document.querySelector(".error");
      message.classList.remove("hidden");
      message.innerText = "ERROR: " + event.data;
    }

    function onReady(event) {
      loadVideo(event.target);
      loadControls(event.target);
      setupMidiListeners(event.target);
    }

    // It seems there's no explicit way to load a video,
    // so instead we mute the video and start playing it immediately.
    // YouTube will lazily load the video as it plays,
    // which is why we select the fastest playback rate allowed.
    function loadVideo(player) {
      const rates = player.getAvailablePlaybackRates();
      player.setPlaybackRate(rates[rates.length - 1]);
      player.mute();
      player.playVideo();
    }

    const inputs = document.querySelectorAll("[data-note] input");
    function loadControls(player) {
      const unit = player.getDuration() / 12;
      inputs.forEach((x, i) => x.placeholder = (i * unit).toFixed(1));
      document.querySelector(".controls").classList.remove("hidden");
    }

    function setupMidiListeners(player) {
      window.addEventListener("keydown", event => onFakeMidi(event, player, 144, 100));
      window.addEventListener("keyup", event => onFakeMidi(event, player, 128, 0));
      navigator.requestMIDIAccess().then(function(midi) {
        for(const input of midi.inputs.values())
          input.onmidimessage = event => onMidi(player, Array.from(event.data), event.timeStamp);
      });
    }

    // Use the keyboard as a backup MIDI controller â€” GarageBand layout
    const keys = [ "a", "w", "s", "e", "d", "f", "t", "g", "y", "h", "u", "j"];
    function onFakeMidi(event, player, status, velocity) {
      const index = keys.indexOf(event.key);
      if (index !== -1 && !event.repeat)
        onMidi(player, [ status, index, velocity ], performance.now());
    }

    // Make it a playable instrument!
    const hold = {};
    function onMidi(player, data, time) {
      if (data.length === 3 && data[0] >> 4 === 8) {
        // NOTE OFF
        const note = toNote(data[1]);
        const input = inputs[note];
        hold[note] = false;

        input.parentNode.classList.remove("pressed");
        if (!Object.values(hold).includes(true))
          player.mute();
      } else if (data.length === 3 && data[0] >> 4 === 9) {
        // NOTE ON
        const note = toNote(data[1]);
        const input = inputs[note];
        hold[note] = true;

        input.parentNode.classList.add("pressed");
        player.setPlaybackRate(1);
        player.seekTo(getValue(input));
        player.unMute();
        player.playVideo();
      }
    }

    function getValue(input) {
      const draft = parseFloat(input.value);
      return isNaN(draft) ? parseFloat(input.placeholder) : draft;
    }

    function toNote(i) {
      return i % 12;
    }
  </script>
</body>
</html>

